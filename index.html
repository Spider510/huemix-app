<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>HÃœMIX Einsatz</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- SheetJS fÃ¼r XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#f4f7f4; margin:0; padding:10px; }
h1 { color:#2e7d32; }
label { font-weight:bold; display:block; margin-top:10px; }
input, select, button {
  width:100%; padding:10px; margin-top:5px;
  font-size:16px; box-sizing:border-box;
}
button { border:none; color:#fff; cursor:pointer; margin-top:10px; }
.green { background:#2e7d32; }
.blue { background:#1976d2; }
.gray { background:#455a64; }
.purple { background:#6a1b9a; }
.orange { background:#ef6c00; }
.red { background:#c62828; }
.status { margin-top:10px; font-size:14px; }
</style>
</head>

<body>

<h1>ğŸŒ± HÃœMIX Einsatz</h1>

<label>Name</label>
<input id="name">

<label>Telefon</label>
<input id="telefon" inputmode="tel">

<label>StraÃŸe</label>
<input id="strasse">

<label>Hausnummer</label>
<input id="hausnr">

<label>PLZ</label>
<input id="plz">

<label>Ort</label>
<input id="ort">

<label>Rasen Spezial â€“ SÃ¤cke (45 â‚¬)</label>
<input id="rasen" type="number" value="0">

<label>Bio-VolldÃ¼nger â€“ SÃ¤cke (30 â‚¬)</label>
<input id="bio" type="number" value="0">

<label>Ausgestreut</label>
<select id="ausgestreut">
  <option>Ja</option>
  <option>Nein</option>
</select>

<label>Zahlungsart</label>
<select id="zahlung">
  <option>Bar</option>
  <option>EC</option>
</select>

<button class="blue" onclick="gpsHolen()">ğŸ“ GPS neu holen</button>
<div class="status" id="gpsStatus">GPS noch nicht ermittelt</div>

<button class="green" onclick="speichern()">ğŸ’¾ Speichern</button>
<button class="blue" onclick="felderLeeren()">â• Neuer Eintrag</button>

<!-- CSV unverÃ¤ndert -->
<button class="gray" onclick="exportTagesCSV()">ğŸ“„ Tages-CSV</button>

<!-- XLSX -->
<button class="orange" onclick="exportXLSX()">ğŸ“Š Excel-XLSX</button>

<button class="purple" onclick="exportZusammenfassung()">ğŸ“Š Tageszusammenfassung CSV</button>
<button class="red" onclick="allesLoeschen()">ğŸ—‘ Alle Daten lÃ¶schen</button>

<div class="status" id="status">Bereit.</div>

<script>
let lat = null, lon = null;

/* ================= GPS ================= */
function gpsHolen() {
  felderLeeren();
  document.getElementById("gpsStatus").innerText = "GPS wird ermitteltâ€¦";

  navigator.geolocation.getCurrentPosition(pos => {
    lat = pos.coords.latitude;
    lon = pos.coords.longitude;

    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
      .then(r => r.json())
      .then(d => {
        document.getElementById("strasse").value = (d.address && d.address.road) ? d.address.road : "";
        document.getElementById("hausnr").value  = (d.address && d.address.house_number) ? d.address.house_number : "";
        document.getElementById("plz").value     = (d.address && d.address.postcode) ? d.address.postcode : "";
        document.getElementById("ort").value     = (d.address && (d.address.city || d.address.town || d.address.village)) ? (d.address.city || d.address.town || d.address.village) : "";
        document.getElementById("gpsStatus").innerText = `GPS OK: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
      });
  }, () => alert("GPS nicht verfÃ¼gbar"));
}

/* ================= SPEICHERN (FIX NUR HIER) ================= */
function speichern() {
  try {
    const daten = JSON.parse(localStorage.getItem("humix") || "[]");

    // âœ… zuverlÃ¤ssig per getElementById lesen (kein Safari-Globals / kein window.name Problem)
    const rasenVal = Number(document.getElementById("rasen").value || 0);
    const bioVal   = Number(document.getElementById("bio").value || 0);
    const summe    = rasenVal * 45 + bioVal * 30;

    const jetzt   = new Date();
    const datum   = jetzt.toLocaleDateString("de-DE");
    const uhrzeit = jetzt.toLocaleTimeString("de-DE", { hour:"2-digit", minute:"2-digit" });

    daten.push({
      datum,
      uhrzeit,
      name: document.getElementById("name").value || "",
      telefon: document.getElementById("telefon").value || "",
      strasse: document.getElementById("strasse").value || "",
      hausnr: document.getElementById("hausnr").value || "",
      plz: document.getElementById("plz").value || "",
      ort: document.getElementById("ort").value || "",
      rasen: rasenVal,
      bio: bioVal,
      ausgestreut: document.getElementById("ausgestreut").value,
      zahlung: document.getElementById("zahlung").value,
      summe
    });

    localStorage.setItem("humix", JSON.stringify(daten));

    document.getElementById("status").innerText = "Gespeichert âœ”";
    felderLeeren(); // âœ… wird jetzt sicher ausgefÃ¼hrt
  } catch (e) {
    document.getElementById("status").innerText = "Fehler beim Speichern";
    alert("Speichern fehlgeschlagen: " + (e && e.message ? e.message : e));
  }
}

/* ================= RESET (unverÃ¤ndert) ================= */
function felderLeeren() {
  ["name","telefon","strasse","hausnr","plz","ort"].forEach(id => document.getElementById(id).value = "");
  document.getElementById("rasen").value = 0;
  document.getElementById("bio").value = 0;
}

/* ================= CSV (unverÃ¤ndert) ================= */
function exportTagesCSV() {
  const daten = JSON.parse(localStorage.getItem("humix") || "[]");
  if (!daten.length) return alert("Keine Daten");

  let csv = "Datum;Uhrzeit;Name;Telefon;StraÃŸe;Hausnr;PLZ;Ort;Rasen;Bio;Ausgestreut;Zahlung;Summe â‚¬\n";
  daten.forEach(e=>{
    // Telefon so, dass Excel die fÃ¼hrende 0 behÃ¤lt:
    const tel = String(e.telefon || "").replace(/"/g,'""');
    csv += `${e.datum};${e.uhrzeit};${e.name};="${tel}";${e.strasse};${e.hausnr};${e.plz};${e.ort};${e.rasen};${e.bio};${e.ausgestreut};${e.zahlung};${e.summe}\n`;
  });
  downloadCSV(csv,"humix_tagesliste.csv");
}

/* ================= XLSX (unverÃ¤ndert) ================= */
function exportXLSX() {
  const daten = JSON.parse(localStorage.getItem("humix") || "[]");
  if (!daten.length) return alert("Keine Daten");

  const sheetData = [
    ["Datum","Uhrzeit","Name","Telefon","StraÃŸe","Hausnr","PLZ","Ort","Rasen","Bio","Ausgestreut","Zahlung","Summe â‚¬"]
  ];

  daten.forEach(e=>{
    sheetData.push([
      e.datum, e.uhrzeit, e.name, e.telefon,
      e.strasse, e.hausnr, e.plz, e.ort,
      e.rasen, e.bio, e.ausgestreut, e.zahlung, e.summe
    ]);
  });

  const ws = XLSX.utils.aoa_to_sheet(sheetData);

  ws["!cols"] = sheetData[0].map((_,i)=>({
    wch: Math.max(...sheetData.map(r=>String(r[i]||"").length))+2
  }));

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "HÃœMIX");
  XLSX.writeFile(wb, "humix_tagesliste.xlsx");
}

/* ================= ZUSAMMENFASSUNG CSV (unverÃ¤ndert) ================= */
function exportZusammenfassung() {
  const daten = JSON.parse(localStorage.getItem("humix") || "[]");
  if (!daten.length) return alert("Keine Daten");

  const datum = daten[0].datum;
  let bR=0,bB=0,bS=0,eR=0,eB=0,eS=0;

  daten.forEach(e=>{
    if(e.zahlung==="Bar"){bR+=e.rasen;bB+=e.bio;bS+=e.summe;}
    if(e.zahlung==="EC"){eR+=e.rasen;eB+=e.bio;eS+=e.summe;}
  });

  let csv = "Datum;Zahlung;Rasen SÃ¤cke;Bio SÃ¤cke;Summe â‚¬\n";
  csv += `${datum};Bar;${bR};${bB};${bS}\n`;
  csv += `${datum};EC;${eR};${eB};${eS}\n`;
  csv += `${datum};GESAMT;${bR+eR};${bB+eB};${bS+eS}`;

  downloadCSV(csv,"humix_tageszusammenfassung.csv");
}

/* ================= DOWNLOAD CSV (unverÃ¤ndert) ================= */
function downloadCSV(text,name){
  const blob = new Blob(["\uFEFF"+text],{type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
}

/* ================= LÃ–SCHEN (unverÃ¤ndert) ================= */
function allesLoeschen(){
  if(confirm("Wirklich alle Daten lÃ¶schen?")){
    localStorage.removeItem("humix");
    alert("GelÃ¶scht");
  }
}
</script>
</body>
</html>