<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>HÃœMIX Einsatz</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; background:#f4f6f4; margin:0; }
.container { max-width:900px; margin:auto; padding:15px; }
h1 { color:#2e7d32; }
label { font-weight:bold; margin-top:12px; display:block; }
input, select, button {
  width:100%; padding:10px; margin-top:4px;
  border-radius:6px; border:1px solid #ccc;
}
button { font-size:16px; margin-top:10px; }
.green { background:#2e7d32; color:white; }
.blue { background:#1976d2; color:white; }
.gray { background:#455a64; color:white; }
.purple { background:#6a1b9a; color:white; }
.red { background:#c62828; color:white; }
.small { font-size:14px; margin-top:6px; }
</style>
</head>

<body>
<div class="container">

<h1>ğŸŒ± HÃœMIX Einsatz</h1>

<label>Name</label>
<input id="kundenname">

<label>Telefon</label>
<input id="telefon" placeholder="z.B. 01711234567">

<label>StraÃŸe</label>
<input id="strasse">

<label>Hausnummer</label>
<input id="hausnr">

<label>PLZ</label>
<input id="plz">

<label>Ort</label>
<input id="ort">

<label>Rasen Spezial â€“ SÃ¤cke (45 â‚¬)</label>
<input id="rasen" type="number" value="0">

<label>Bio-VolldÃ¼nger â€“ SÃ¤cke (30 â‚¬)</label>
<input id="bio" type="number" value="0">

<label>Ausgestreut</label>
<select id="ausgestreut">
  <option>Ja</option>
  <option>Nein</option>
</select>

<label>Zahlungsart</label>
<select id="zahlung">
  <option>Bar</option>
  <option>EC</option>
</select>

<button class="blue" onclick="gpsNeu()">ğŸ“ GPS neu holen</button>
<div id="gpsStatus" class="small">GPS noch nicht ermittelt</div>

<button class="green" onclick="speichern()">ğŸ’¾ Speichern</button>
<button class="blue" onclick="resetForm()">â• Neuer Eintrag</button>
<button class="gray" onclick="tagesCSV()">ğŸ“„ Tages-CSV</button>
<button class="purple" onclick="tagesZusammenfassung()">ğŸ“Š Tageszusammenfassung</button>
<button class="red" onclick="allesLoeschen()">ğŸ—‘ï¸ Alle Daten lÃ¶schen</button>

<div id="status" class="small">Bereit.</div>

</div>

<script>
const PREIS_RASEN = 45;
const PREIS_BIO = 30;
let gps = null;

/* ========= RESET ========= */
function resetForm() {
  document.querySelectorAll("input").forEach(i => i.value = "");
  rasen.value = 0;
  bio.value = 0;
  ausgestreut.value = "Ja";
  zahlung.value = "Bar";
  gps = null;
  gpsStatus.innerText = "GPS noch nicht ermittelt";
}

/* ========= DATUM ========= */
function datumZeit() {
  const d = new Date();
  return d.toLocaleDateString("de-DE") + " " +
         d.toLocaleTimeString("de-DE",{hour:'2-digit',minute:'2-digit'});
}
function datumOhneZeit() {
  return new Date().toLocaleDateString("de-DE");
}

/* ========= GPS ========= */
function gpsNeu() {
  resetForm();
  if (!navigator.geolocation) {
    gpsStatus.innerText = "GPS nicht unterstÃ¼tzt";
    return;
  }
  navigator.geolocation.getCurrentPosition(pos => {
    gps = pos.coords;
    gpsStatus.innerText = `GPS OK: ${gps.latitude.toFixed(5)}, ${gps.longitude.toFixed(5)}`;
    adresseAusGPS(gps.latitude, gps.longitude);
  }, () => gpsStatus.innerText = "GPS Fehler");
}

function adresseAusGPS(lat, lon) {
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
    .then(r => r.json())
    .then(d => {
      if (!d.address) return;
      strasse.value = d.address.road || "";
      hausnr.value = d.address.house_number || "";
      plz.value = d.address.postcode || "";
      ort.value = d.address.city || d.address.town || d.address.village || "";
    });
}

/* ========= SPEICHERN ========= */
function speichern() {
  const eintrag = {
    datum: datumZeit(),
    name: kundenname.value.trim(),   // âœ… FIX: kein window.name mehr
    telefon: telefon.value.trim(),
    strasse: strasse.value.trim(),
    hausnr: hausnr.value.trim(),
    plz: plz.value.trim(),
    ort: ort.value.trim(),
    rasen: Number(rasen.value),
    bio: Number(bio.value),
    ausgestreut: ausgestreut.value,
    zahlung: zahlung.value
  };
  eintrag.summe = eintrag.rasen * PREIS_RASEN + eintrag.bio * PREIS_BIO;

  const daten = JSON.parse(localStorage.getItem("huemix") || "[]");
  daten.push(eintrag);
  localStorage.setItem("huemix", JSON.stringify(daten));

  resetForm();
  status.innerText = "Gespeichert âœ”";
}

/* ========= CSV ========= */
function downloadCSV(name, text) {
  const blob = new Blob(["\ufeff" + text], { type:"text/csv;charset=utf-8;" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
}

function tagesCSV() {
  const daten = JSON.parse(localStorage.getItem("huemix") || "[]");
  let csv = "Datum;Name;Telefon;StraÃŸe;Hausnr;PLZ;Ort;Rasen;Bio;Ausgestreut;Zahlung;Summe\n";
  daten.forEach(e => {
    csv += [
      e.datum,
      e.name,
      `="${String(e.telefon).replace(/"/g,'""')}"`, // âœ… FIX: fÃ¼hrende 0 bleibt
      e.strasse,
      e.hausnr,
      e.plz,
      e.ort,
      e.rasen,
      e.bio,
      e.ausgestreut,
      e.zahlung,
      e.summe
    ].join(";") + "\n";
  });
  downloadCSV("huemix_tagesliste.csv", csv);
}

/* ========= ZUSAMMENFASSUNG ========= */
function tagesZusammenfassung() {
  const daten = JSON.parse(localStorage.getItem("huemix") || "[]");
  let bar = { r:0, b:0, s:0 };
  let ec  = { r:0, b:0, s:0 };

  daten.forEach(e => {
    const t = e.zahlung === "Bar" ? bar : ec;
    t.r += e.rasen;
    t.b += e.bio;
    t.s += e.summe;
  });

  let csv =
`Datum:${datumOhneZeit()}
Zahlung;Rasen SÃ¤cke;Bio SÃ¤cke;Summe â‚¬
Bar;${bar.r};${bar.b};${bar.s}
EC;${ec.r};${ec.b};${ec.s}
GESAMT;${bar.r+ec.r};${bar.b+ec.b};${bar.s+ec.s}`;

  downloadCSV("huemix_tageszusammenfassung.csv", csv);
}

/* ========= LÃ–SCHEN ========= */
function allesLoeschen() {
  if (confirm("Wirklich alle Daten lÃ¶schen?")) {
    localStorage.removeItem("huemix");
    resetForm();
    status.innerText = "Alle Daten gelÃ¶scht";
  }
}
</script>
</body>
</html>