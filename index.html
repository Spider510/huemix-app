<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HÃœMIX Einsatz</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2e7d32">

<style>
body { font-family: Arial, sans-serif; background:#f4f6f4; margin:0; padding:20px; }
h1 { color:#2e7d32; }
label { font-weight:bold; }
input, select, button {
  width:100%; padding:10px; margin:6px 0 14px 0;
  font-size:16px;
}
button { border:none; color:#fff; cursor:pointer; }
.save { background:#2e7d32; }
.new { background:#1976d2; }
.export { background:#455a64; }
.delete { background:#c62828; }
.box { background:#fff; padding:15px; border-radius:6px; }
.small { font-size:13px; color:#555; }
</style>
</head>

<body>
<h1>ðŸŒ± HÃœMIX Einsatz</h1>

<div class="box">

<label>Name</label>
<input id="name">

<label>Telefon</label>
<input id="telefon">

<label>StraÃŸe</label>
<input id="strasse">

<label>Hausnummer</label>
<input id="hausnr">

<label>PLZ</label>
<input id="plz">

<label>Ort</label>
<input id="ort">

<label>HÃœMIX Rasen Spezial â€“ SÃ¤cke (45 â‚¬)</label>
<input id="rasen" type="number" value="0">

<label>HÃœMIX Bio-VolldÃ¼nger â€“ SÃ¤cke (30 â‚¬)</label>
<input id="bio" type="number" value="0">

<label>Ausgestreut</label>
<select id="ausgestreut">
  <option>Ja</option>
  <option>Nein</option>
</select>

<label>Zahlungsart</label>
<select id="zahlung">
  <option>Bar</option>
  <option>EC</option>
</select>

<button class="save" onclick="speichern()">ðŸ’¾ Speichern</button>
<button class="new" onclick="neuerEintrag()">âž• Neuer Eintrag</button>
<button class="export" onclick="exportCSV()">ðŸ“„ Alle EintrÃ¤ge CSV</button>
<button class="export" onclick="exportSummary()">ðŸ“Š Tages-Zusammenfassung CSV</button>
<button class="delete" onclick="allesLoeschen()">ðŸ—‘ Alle Daten lÃ¶schen</button>

<p class="small" id="gpsinfo">GPS wird ermitteltâ€¦</p>

</div>

<script>
const PREIS_RASEN = 45;
const PREIS_BIO = 30;
let lat = null, lon = null;

/* GPS + Adresse */
navigator.geolocation.getCurrentPosition(pos => {
  lat = pos.coords.latitude;
  lon = pos.coords.longitude;
  document.getElementById("gpsinfo").innerText =
    `GPS OK: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;

  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
    .then(r => r.json())
    .then(d => {
      if (!d.address) return;
      document.getElementById("strasse").value = d.address.road || "";
      document.getElementById("hausnr").value = d.address.house_number || "";
      document.getElementById("plz").value = d.address.postcode || "";
      document.getElementById("ort").value =
        d.address.city || d.address.town || d.address.village || "";
    });
}, () => {
  document.getElementById("gpsinfo").innerText = "GPS nicht verfÃ¼gbar";
});

/* Speichern */
function speichern() {
  const jetzt = new Date();
  const datum = jetzt.toLocaleDateString("de-DE") + ", " +
                jetzt.toLocaleTimeString("de-DE", {hour:'2-digit', minute:'2-digit'});

  const rasen = Number(rasenEl.value);
  const bio = Number(bioEl.value);
  const summe = rasen * PREIS_RASEN + bio * PREIS_BIO;

  const eintrag = {
    datum,
    name: name.value,
    telefon: telefon.value,
    strasse: strasse.value,
    hausnr: hausnr.value,
    plz: plz.value,
    ort: ort.value,
    rasen,
    bio,
    ausgestreut: ausgestreut.value,
    zahlung: zahlung.value,
    summe
  };

  const daten = JSON.parse(localStorage.getItem("huemix")) || [];
  daten.push(eintrag);
  localStorage.setItem("huemix", JSON.stringify(daten));

  alert("Gespeichert âœ”");
}

/* Neuer Eintrag */
function neuerEintrag() {
  document.querySelectorAll("input").forEach(i => {
    if (i.type === "number") i.value = 0;
    else i.value = "";
  });
}

/* CSV Export */
function exportCSV() {
  const daten = JSON.parse(localStorage.getItem("huemix")) || [];
  let csv = "Datum;Name;Telefon;StraÃŸe;Hausnr;PLZ;Ort;Rasen;Bio;Ausgestreut;Zahlung;Summe\n";

  daten.forEach(e => {
    if (!e || !e.datum) return;
    csv += [
      e.datum, e.name, e.telefon, e.strasse, e.hausnr,
      e.plz, e.ort, e.rasen, e.bio, e.ausgestreut, e.zahlung, e.summe
    ].join(";") + "\n";
  });

  download(csv, "huemix_alle_eintraege.csv");
}

/* Tages-Zusammenfassung */
function exportSummary() {
  const daten = JSON.parse(localStorage.getItem("huemix")) || [];
  let barR=0, barB=0, barS=0, ecR=0, ecB=0, ecS=0;

  daten.forEach(e => {
    if (e.zahlung === "Bar") {
      barR+=e.rasen; barB+=e.bio; barS+=e.summe;
    } else {
      ecR+=e.rasen; ecB+=e.bio; ecS+=e.summe;
    }
  });

  let csv =
    "Zahlung;Rasen SÃ¤cke;Bio SÃ¤cke;Summe â‚¬\n" +
    `Bar;${barR};${barB};${barS}\n` +
    `EC;${ecR};${ecB};${ecS}\n`;

  download(csv, "huemix_tageszusammenfassung.csv");
}

/* LÃ¶schen */
function allesLoeschen() {
  if (confirm("Wirklich alle Daten lÃ¶schen?")) {
    localStorage.removeItem("huemix");
    alert("Alle Daten gelÃ¶scht");
  }
}

/* Download Helper */
function download(text, name) {
  const blob = new Blob(["\uFEFF"+text], {type:"text/csv;charset=utf-8;"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
}

/* PWA */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>