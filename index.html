<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>HÃœMIX Einsatz</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="HÃœMIX Einsatz">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
body{font-family:Arial,sans-serif;background:#f4f7f4;margin:0;padding:12px}
h1{color:#2e7d32}
label{font-weight:bold;margin-top:10px;display:block}
input,select,button{width:100%;padding:10px;margin-top:4px;font-size:16px}
button{border:none;border-radius:4px;color:#fff;margin-top:8px}
.green{background:#2e7d32}
.blue{background:#1976d2}
.gray{background:#546e7a}
.purple{background:#7b1fa2}
.red{background:#c62828}
#status,#gps{margin-top:10px;font-size:14px;white-space:pre-wrap}
.small{font-size:12px;color:#555;margin-top:8px}
</style>
</head>

<body>
<h1>ğŸŒ± HÃœMIX Einsatz</h1>

<label>Name</label><input id="kundenname">
<label>Telefon</label><input id="telefon">
<label>StraÃŸe</label><input id="strasse">
<label>Hausnummer</label><input id="hausnr">
<label>PLZ</label><input id="plz">
<label>Ort</label><input id="ort">

<label>Rasen Spezial â€“ SÃ¤cke (45 â‚¬)</label>
<input id="rasen" type="number" value="0" min="0">

<label>Bio-VolldÃ¼nger â€“ SÃ¤cke (30 â‚¬)</label>
<input id="bio" type="number" value="0" min="0">

<label>Ausgestreut</label>
<select id="ausgestreut">
  <option>Ja</option>
  <option>Nein</option>
</select>

<label>Zahlungsart</label>
<select id="zahlung">
  <option>Bar</option>
  <option>EC</option>
</select>

<button class="blue" onclick="gpsHolen()">ğŸ“ GPS & Adresse holen</button>
<div id="gps">GPS noch nicht ermittelt</div>

<button class="green" onclick="speichern()">ğŸ’¾ Speichern</button>
<button class="gray" onclick="tagesCSV()">ğŸ“„ Tages-CSV exportieren</button>
<button class="purple" onclick="tagesSumme()">ğŸ“Š Tageszusammenfassung CSV</button>
<button class="red" onclick="allesLoeschen()">ğŸ—‘ Alle Daten lÃ¶schen</button>

<div class="small">
iPad/iPhone: Export â†’ â€Teilenâ€œ â†’ â€In Dateien sichernâ€œ
</div>

<div id="status">Bereit.</div>

<script>
let lat=null, lon=null;
const PREIS_RASEN=45, PREIS_BIO=30;

function zeit(){
  const d=new Date();
  return d.toLocaleDateString("de-DE")+" "+
         d.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});
}

function zeitstempel(prefix){
  const d=new Date();
  return prefix+"_"+d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")+
         "_"+String(d.getHours()).padStart(2,"0")+String(d.getMinutes()).padStart(2,"0")+".csv";
}

function neu(){
  document.querySelectorAll("input").forEach(i=>{
    if(i.type==="number") i.value=0;
    else i.value="";
  });
  gps.textContent="GPS noch nicht ermittelt";
  lat=null; lon=null;
}

async function gpsHolen(){
  neu();
  gps.textContent="GPS wird ermitteltâ€¦";
  navigator.geolocation.getCurrentPosition(async p=>{
    lat=p.coords.latitude;
    lon=p.coords.longitude;
    gps.textContent=`GPS OK: ${lat.toFixed(6)}, ${lon.toFixed(6)}\nAdresse wird geladenâ€¦`;

    try{
      const r=await fetch(
        `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`,
        {headers:{"User-Agent":"HuemixApp"}}
      );
      const d=await r.json();
      if(d.address){
        strasse.value=d.address.road||"";
        hausnr.value=d.address.house_number||"";
        plz.value=d.address.postcode||"";
        ort.value=d.address.city||d.address.town||d.address.village||"";
        gps.textContent+="\nAdresse Ã¼bernommen âœ”";
      }
    }catch{
      gps.textContent+="\nAdresse konnte nicht geladen werden";
    }
  },()=>gps.textContent="GPS Fehler",{enableHighAccuracy:true,timeout:15000});
}

function speichern(){
  const r=Number(rasen.value)||0;
  const b=Number(bio.value)||0;
  const sum=r*PREIS_RASEN+b*PREIS_BIO;

  const eintrag={
    datum:zeit(),
    name:kundenname.value||"",
    telefon:telefon.value||"",
    strasse:strasse.value||"",
    hausnr:hausnr.value||"",
    plz:plz.value||"",
    ort:ort.value||"",
    rasen:r,
    bio:b,
    ausgestreut:ausgestreut.value,
    zahlung:zahlung.value,
    summe:sum
  };

  const l=JSON.parse(localStorage.getItem("huemix")||"[]");
  l.push(eintrag);
  localStorage.setItem("huemix",JSON.stringify(l));

  status.textContent="Gespeichert âœ” â€“ bereit fÃ¼r nÃ¤chsten Eintrag";
  neu();
}

async function exportCSV(text,filename){
  const csv="\uFEFF"+text.replace(/\n/g,"\r\n");
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  try{
    if(navigator.canShare&&navigator.canShare({files:[new File([blob],filename)]})){
      await navigator.share({files:[new File([blob],filename)]});
      return;
    }
  }catch{}
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  a.click();
}

function tagesCSV(){
  const l=JSON.parse(localStorage.getItem("huemix")||"[]");
  let csv="Datum;Name;Telefon;StraÃŸe;Hausnr;PLZ;Ort;Rasen;Bio;Ausgestreut;Zahlung;Summe\n";
  l.forEach(e=>{
    csv+=`${e.datum};${e.name};${e.telefon};${e.strasse};${e.hausnr};${e.plz};${e.ort};${e.rasen};${e.bio};${e.ausgestreut};${e.zahlung};${e.summe}\n`;
  });
  exportCSV(csv,zeitstempel("huemix_tag"));
}

function tagesSumme(){
  const l=JSON.parse(localStorage.getItem("huemix")||"[]");

  let bar={r:0,b:0,s:0};
  let ec ={r:0,b:0,s:0};

  l.forEach(e=>{
    const s=e.rasen*PREIS_RASEN+e.bio*PREIS_BIO;
    if(e.zahlung==="Bar"){bar.r+=e.rasen;bar.b+=e.bio;bar.s+=s;}
    if(e.zahlung==="EC"){ec.r+=e.rasen;ec.b+=e.bio;ec.s+=s;}
  });

  const gesamt={
    r: bar.r + ec.r,
    b: bar.b + ec.b,
    s: bar.s + ec.s
  };

  let csv="Zahlung;Rasen SÃ¤cke;Bio SÃ¤cke;Summe â‚¬\n";
  csv+=`Bar;${bar.r};${bar.b};${bar.s}\n`;
  csv+=`EC;${ec.r};${ec.b};${ec.s}\n`;
  csv+=`GESAMT;${gesamt.r};${gesamt.b};${gesamt.s}\n`;

  exportCSV(csv,zeitstempel("huemix_tageszusammenfassung"));

  status.textContent=
`BAR: ${bar.s} â‚¬
EC:  ${ec.s} â‚¬
GESAMT: ${gesamt.s} â‚¬`;
}

function allesLoeschen(){
  if(confirm("Wirklich alle Daten lÃ¶schen?")){
    localStorage.removeItem("huemix");
    status.textContent="Alle Daten gelÃ¶scht";
  }
}
</script>
</body>
</html>