<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>HÃœMIX Einsatz</title>

<style>
body{font-family:Arial;background:#f4f8f4;padding:20px}
h1{color:#2e7d32}
label{display:block;margin-top:10px}
input,select{width:100%;padding:8px}
button{width:100%;padding:12px;margin-top:10px;font-size:16px;border:none}
.save{background:#2e7d32;color:#fff}
.new{background:#1976d2;color:#fff}
.csv{background:#455a64;color:#fff}
.del{background:#c62828;color:#fff}
pre{background:#fff;padding:10px;margin-top:15px}
</style>
</head>

<body>

<h1>ðŸŒ± HÃœMIX Einsatz</h1>

<label>Name<input id="name"></label>
<label>Telefon<input id="telefon"></label>
<label>StraÃŸe<input id="strasse"></label>
<label>Hausnummer<input id="hausnr"></label>
<label>PLZ<input id="plz"></label>
<label>Ort<input id="ort"></label>

<label>Rasen Spezial â€“ SÃ¤cke (45 â‚¬)
<input id="rasen" type="number" value="0"></label>

<label>Bio-VolldÃ¼nger â€“ SÃ¤cke (30 â‚¬)
<input id="bio" type="number" value="0"></label>

<label>Ausgestreut
<select id="ausgestreut"><option>Ja</option><option>Nein</option></select></label>

<label>Zahlungsart
<select id="zahlung">
<option>Bar</option>
<option>EC</option>
<option>Rechnung</option>
</select></label>

<button class="save" onclick="speichern()">ðŸ’¾ Speichern</button>
<button class="new" onclick="neu()">âž• Neuer Eintrag</button>
<button class="csv" onclick="exportCSV()">ðŸ“„ Tages-CSV exportieren</button>
<button class="del" onclick="allesLoeschen()">ðŸ—‘ Alle Daten lÃ¶schen</button>

<pre id="status">GPS wird ermitteltâ€¦</pre>

<script>
const PREIS_RASEN=45, PREIS_BIO=30;
let lat="",lon="";

const $=id=>document.getElementById(id);
const status=$("status");

/* GPS + Adresse */
navigator.geolocation.getCurrentPosition(
 pos=>{
  lat=pos.coords.latitude;
  lon=pos.coords.longitude;
  status.textContent="GPS OK â€“ Adresse wird ermitteltâ€¦";
  ladeAdresse(lat,lon);
 },
 err=>status.textContent="GPS Fehler: "+err.message,
 {enableHighAccuracy:true,timeout:10000}
);

function ladeAdresse(lat,lon){
 fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
 .then(r=>r.json())
 .then(d=>{
  const a=d.address||{};
  $("strasse").value=a.road||"";
  $("hausnr").value=a.house_number||"";
  $("plz").value=a.postcode||"";
  $("ort").value=a.city||a.town||a.village||"";
  status.textContent="Adresse automatisch Ã¼bernommen âœ”";
 })
 .catch(()=>status.textContent="Adresse konnte nicht geladen werden");
}

function speichern(){
 const now=new Date();
 const datum=now.toLocaleDateString("de-DE")+" "+now.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});

 const r=+rasen.value||0, b=+bio.value||0;
 const sum=r*PREIS_RASEN+b*PREIS_BIO;

 const eintrag={
  datum,
  name:name.value,
  telefon:telefon.value,
  strasse:strasse.value,
  hausnr:hausnr.value,
  plz:plz.value,
  ort:ort.value,
  rasen:r,
  bio:b,
  ausgestreut:ausgestreut.value,
  zahlung:zahlung.value,
  summe:sum
 };

 const d=JSON.parse(localStorage.getItem("huemix"))||[];
 d.push(eintrag);
 localStorage.setItem("huemix",JSON.stringify(d));

 status.textContent="Gespeichert âœ” Summe "+sum+" â‚¬";
}

function neu(){
 document.querySelectorAll("input").forEach(i=>i.value="");
 rasen.value=0; bio.value=0;
}

function exportCSV(){
 const d=JSON.parse(localStorage.getItem("huemix"))||[];
 if(!d.length)return alert("Keine Daten");

 let csv="Datum;Name;Telefon;StraÃŸe;Hausnr;PLZ;Ort;Rasen;Bio;Ausgestreut;Zahlung;Summe\n";
 let sum={Bar:0,EC:0,Rechnung:0}, sack={Bar:0,EC:0,Rechnung:0};

 d.forEach(e=>{
  csv+=[
   e.datum,e.name,e.telefon,e.strasse,e.hausnr,e.plz,e.ort,
   e.rasen,e.bio,e.ausgestreut,e.zahlung,e.summe
  ].join(";")+"\n";
  sum[e.zahlung]+=e.summe;
  sack[e.zahlung]+=e.rasen+e.bio;
 });

 csv+="\nZUSAMMENFASSUNG\nZahlung;SÃ¤cke;Summe\n";
 ["Bar","EC","Rechnung"].forEach(z=>csv+=`${z};${sack[z]};${sum[z]}\n`);

 const blob=new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download="huemix_"+new Date().toISOString().slice(0,10)+".csv";
 a.click();
}

function allesLoeschen(){
 if(confirm("Alle Daten lÃ¶schen?")){
  localStorage.removeItem("huemix");
  status.textContent="Alle Daten gelÃ¶scht";
 }
}
</script>

</body>
</html>