<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>HÃœMIX Einsatz</title>

<style>
body{font-family:Arial;background:#f4f7f4;margin:0}
.container{max-width:900px;margin:auto;padding:15px}
h1{color:#2e7d32}
label{font-weight:bold}
input,select,button{width:100%;padding:10px;margin-bottom:10px;font-size:16px}
button{border:none;color:#fff;border-radius:4px}
.save{background:#2e7d32}
.new{background:#1976d2}
.csv{background:#455a64}
.sum{background:#6a1b9a}
.del{background:#c62828}
.gps{background:#0288d1}
.status{font-size:14px;padding:6px}
</style>
</head>

<body>
<div class="container">
<h1>ğŸŒ± HÃœMIX Einsatz</h1>

<label>Name</label><input id="name">
<label>Telefon</label><input id="telefon">
<label>StraÃŸe</label><input id="strasse">
<label>Hausnummer</label><input id="hausnr">
<label>PLZ</label><input id="plz">
<label>Ort</label><input id="ort">

<label>Rasen Spezial â€“ SÃ¤cke (45 â‚¬)</label>
<input id="rasen" type="number" value="0">

<label>Bio-VolldÃ¼nger â€“ SÃ¤cke (30 â‚¬)</label>
<input id="bio" type="number" value="0">

<label>Ausgestreut</label>
<select id="ausgestreut"><option>Ja</option><option>Nein</option></select>

<label>Zahlungsart</label>
<select id="zahlung"><option>Bar</option><option>EC</option></select>

<button class="gps" onclick="gpsNeu()">ğŸ“ GPS neu holen</button>
<div id="gpsinfo" class="status">GPS nicht ermittelt</div>

<button class="save" onclick="speichern()">ğŸ’¾ Speichern</button>
<button class="new" onclick="resetForm()">â• Neuer Eintrag</button>
<button class="csv" onclick="exportListe()">ğŸ“„ Tages-CSV</button>
<button class="sum" onclick="exportSumme()">ğŸ“Š Tageszusammenfassung</button>
<button class="del" onclick="allesLoeschen()">ğŸ—‘ï¸ Alle Daten lÃ¶schen</button>

<div id="status" class="status"></div>
</div>

<script>
let gps = {lat:null, lon:null};
let gpsToken = 0;

function resetForm(){
  ["name","telefon","strasse","hausnr","plz","ort"].forEach(id=>document.getElementById(id).value="");
  rasen.value=0; bio.value=0;
  ausgestreut.value="Ja"; zahlung.value="Bar";
}

function gpsNeu(){
  resetForm();
  gps = {lat:null, lon:null};
  gpsToken++;
  const token = gpsToken;
  gpsinfo.textContent="GPS wird ermitteltâ€¦";

  navigator.geolocation.getCurrentPosition(pos=>{
    if(token!==gpsToken) return;
    gps.lat=pos.coords.latitude;
    gps.lon=pos.coords.longitude;
    gpsinfo.textContent=`GPS OK: ${gps.lat.toFixed(6)}, ${gps.lon.toFixed(6)}`;
    adresseVonGPS(token);
  },()=>gpsinfo.textContent="GPS fehlgeschlagen");
}

function adresseVonGPS(token){
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${gps.lat}&lon=${gps.lon}`)
  .then(r=>r.json()).then(d=>{
    if(token!==gpsToken) return;
    strasse.value=d.address.road||"";
    hausnr.value=d.address.house_number||"";
    plz.value=d.address.postcode||"";
    ort.value=d.address.city||d.address.town||d.address.village||"";
  });
}

function speichern(){
  const jetzt=new Date();
  const eintrag={
    datum:jetzt.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"}),
    name:name.value,
    telefon:telefon.value,
    strasse:strasse.value,
    hausnr:hausnr.value,
    plz:plz.value,
    ort:ort.value,
    rasen:+rasen.value||0,
    bio:+bio.value||0,
    ausgestreut:ausgestreut.value,
    zahlung:zahlung.value,
    summe:(rasen.value*45)+(bio.value*30)
  };

  const daten=JSON.parse(localStorage.getItem("huemix")||"[]");
  daten.push(eintrag);
  localStorage.setItem("huemix",JSON.stringify(daten));

  status.textContent="Gespeichert âœ”";
  resetForm();
}

function exportListe(){
  const daten=JSON.parse(localStorage.getItem("huemix")||"[]");
  let csv="Datum;Name;Telefon;StraÃŸe;Hausnr;PLZ;Ort;Rasen;Bio;Ausgestreut;Zahlung;Summe â‚¬\n";
  daten.forEach(e=>{
    csv+=`${e.datum};${e.name};${e.telefon};${e.strasse};${e.hausnr};${e.plz};${e.ort};${e.rasen};${e.bio};${e.ausgestreut};${e.zahlung};${e.summe}\n`;
  });
  download(csv,"huemix_tagesliste.csv");
}

function exportSumme(){
  const daten=JSON.parse(localStorage.getItem("huemix")||"[]");
  let s={Bar:{r:0,b:0,e:0},EC:{r:0,b:0,e:0}};
  daten.forEach(e=>{
    s[e.zahlung].r+=e.rasen;
    s[e.zahlung].b+=e.bio;
    s[e.zahlung].e+=e.summe;
  });

  const d=new Date().toLocaleDateString("de-DE");
  let csv=`Datum;Zahlung;Rasen SÃ¤cke;Bio SÃ¤cke;Summe â‚¬\n`;
  csv+=`${d};Bar;${s.Bar.r};${s.Bar.b};${s.Bar.e}\n`;
  csv+=`${d};EC;${s.EC.r};${s.EC.b};${s.EC.e}\n`;
  csv+=`${d};GESAMT;${s.Bar.r+s.EC.r};${s.Bar.b+s.EC.b};${s.Bar.e+s.EC.e}\n`;

  download(csv,"huemix_tageszusammenfassung.csv");
}

function download(text,name){
  const blob=new Blob(["\ufeff"+text],{type:"text/csv;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=name;
  a.click();
}

function allesLoeschen(){
  if(confirm("Alles lÃ¶schen?")){
    localStorage.removeItem("huemix");
    resetForm();
    status.textContent="Alle Daten gelÃ¶scht";
  }
}
</script>
</body>
</html>