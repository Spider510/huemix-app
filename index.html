<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>HÃœMIX Einsatz</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- PWA / App (optional, falls du die Dateien hast) -->
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="HÃœMIX Einsatz">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
body{font-family:Arial,sans-serif;background:#f4f7f4;margin:0;padding:12px}
h1{color:#2e7d32}
label{font-weight:bold;margin-top:10px;display:block}
input,select,button{width:100%;padding:10px;margin-top:4px;font-size:16px}
button{border:none;border-radius:4px;color:#fff;margin-top:8px}
.green{background:#2e7d32}
.blue{background:#1976d2}
.gray{background:#546e7a}
.purple{background:#7b1fa2}
.red{background:#c62828}
#status,#gps{margin-top:10px;font-size:14px;white-space:pre-wrap}
.small{font-size:12px;color:#555;margin-top:8px}
</style>
</head>

<body>
<h1>ğŸŒ± HÃœMIX Einsatz</h1>

<label>Name</label><input id="kundenname">
<label>Telefon</label><input id="telefon">
<label>StraÃŸe</label><input id="strasse">
<label>Hausnummer</label><input id="hausnr">
<label>PLZ</label><input id="plz">
<label>Ort</label><input id="ort">

<label>Rasen Spezial â€“ SÃ¤cke (45 â‚¬)</label>
<input id="rasen" type="number" value="0" min="0">

<label>Bio-VolldÃ¼nger â€“ SÃ¤cke (30 â‚¬)</label>
<input id="bio" type="number" value="0" min="0">

<label>Ausgestreut</label>
<select id="ausgestreut">
  <option>Ja</option>
  <option>Nein</option>
</select>

<label>Zahlungsart</label>
<select id="zahlung">
  <option>Bar</option>
  <option>EC</option>
</select>

<button class="blue" onclick="gpsHolen()">ğŸ“ GPS & Adresse holen</button>
<div id="gps">GPS noch nicht ermittelt</div>

<button class="green" onclick="speichern()">ğŸ’¾ Speichern</button>
<button class="blue" onclick="neu()">â• Neuer Eintrag</button>
<button class="gray" onclick="tagesCSV()">ğŸ“„ Tages-CSV exportieren</button>
<button class="purple" onclick="tagesSumme()">ğŸ“Š Tageszusammenfassung CSV</button>
<button class="red" onclick="allesLoeschen()">ğŸ—‘ Alle Daten lÃ¶schen</button>

<div class="small">
Tipp iPad/iPhone: Beim Export Ã¶ffnet sich â€Teilenâ€œ. Dort â€In Dateien sichernâ€œ auswÃ¤hlen.
</div>

<div id="status">Bereit.</div>

<script>
let lat=null, lon=null;

const PREIS_RASEN = 45;
const PREIS_BIO = 30;

function zeit() {
  const d = new Date();
  return d.toLocaleDateString("de-DE") + " " +
         d.toLocaleTimeString("de-DE", {hour:"2-digit", minute:"2-digit"});
}

function zeitstempelDateiname(prefix) {
  // yyyy-mm-dd_hhmm -> verhindert iOS Ãœberschreiben/Cache
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const mi = String(d.getMinutes()).padStart(2,'0');
  return `${prefix}_${yyyy}-${mm}-${dd}_${hh}${mi}.csv`;
}

async function gpsHolen(){
  gps.textContent = "GPS wird ermitteltâ€¦";
  if (!navigator.geolocation) {
    gps.textContent = "GPS nicht verfÃ¼gbar";
    return;
  }

  navigator.geolocation.getCurrentPosition(async p=>{
    lat = p.coords.latitude;
    lon = p.coords.longitude;
    gps.textContent = `GPS OK: ${lat.toFixed(6)}, ${lon.toFixed(6)}\nAdresse wird geladenâ€¦`;

    try {
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`;
      const r = await fetch(url, { headers: { "User-Agent":"HuemixApp" }});
      const d = await r.json();
      if (d.address) {
        strasse.value = d.address.road || "";
        hausnr.value  = d.address.house_number || "";
        plz.value     = d.address.postcode || "";
        ort.value     = d.address.city || d.address.town || d.address.village || "";
        gps.textContent = `GPS OK: ${lat.toFixed(6)}, ${lon.toFixed(6)}\nAdresse Ã¼bernommen âœ”`;
      } else {
        gps.textContent = `GPS OK: ${lat.toFixed(6)}, ${lon.toFixed(6)}\nAdresse nicht gefunden`;
      }
    } catch (e) {
      gps.textContent = `GPS OK: ${lat.toFixed(6)}, ${lon.toFixed(6)}\nAdresse konnte nicht geladen werden`;
    }
  }, err=>{
    gps.textContent = "GPS Fehler: " + (err && err.message ? err.message : "");
  }, { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
}

function speichern(){
  const r = Number(rasen.value) || 0;
  const b = Number(bio.value) || 0;
  const sum = r*PREIS_RASEN + b*PREIS_BIO;

  const eintrag = {
    datum: zeit(),
    name: kundenname.value || "",
    telefon: telefon.value || "",
    strasse: strasse.value || "",
    hausnr: hausnr.value || "",
    plz: plz.value || "",
    ort: ort.value || "",
    rasen: r,
    bio: b,
    ausgestreut: ausgestreut.value,
    zahlung: zahlung.value,
    summe: sum
  };

  const l = JSON.parse(localStorage.getItem("huemix") || "[]");
  l.push(eintrag);
  localStorage.setItem("huemix", JSON.stringify(l));

  status.textContent = "Gespeichert âœ”";
}

function neu(){
  document.querySelectorAll("input").forEach(i => {
    if (i.type === "number") i.value = 0;
    else i.value = "";
  });
  gps.textContent = "GPS noch nicht ermittelt";
  lat = null; lon = null;
  status.textContent = "Bereit.";
}

/* === iOS-sicherer CSV Export ===
   1) Erst Web Share API mit echter Datei (iOS ideal)
   2) Fallback: klassischer Download-Link
*/
async function exportCSV(text, filename){
  // Excel + Umlaute + saubere Zeilenenden:
  const csvText = "\uFEFF" + text.replace(/\n/g, "\r\n");
  const blob = new Blob([csvText], { type:"text/csv;charset=utf-8" });

  // iOS/iPadOS: Teilen -> "In Dateien sichern" funktioniert zuverlÃ¤ssig
  try {
    if (navigator.canShare && navigator.canShare({ files: [new File([blob], filename, {type:"text/csv"})] })) {
      const file = new File([blob], filename, { type:"text/csv" });
      await navigator.share({ files:[file], title: filename });
      status.textContent = "CSV exportiert (Teilen) âœ”";
      return;
    }
  } catch (_) {
    // wenn Share abgebrochen wird -> fallback
  }

  // Fallback: normaler Download
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.rel = "noopener";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 2000);
  status.textContent = "CSV exportiert (Download) âœ”";
}

function tagesCSV(){
  const l = JSON.parse(localStorage.getItem("huemix") || "[]");

  // Header
  let csv = "Datum;Name;Telefon;StraÃŸe;Hausnr;PLZ;Ort;Rasen;Bio;Ausgestreut;Zahlung;Summe\n";

  // Daten
  l.forEach(e=>{
    if(!e) return;
    csv += `${e.datum||""};${e.name||""};${e.telefon||""};${e.strasse||""};${e.hausnr||""};${e.plz||""};${e.ort||""};${Number(e.rasen)||0};${Number(e.bio)||0};${e.ausgestreut||""};${e.zahlung||""};${Number(e.summe)||0}\n`;
  });

  // FÃ¼r iOS: eindeutiger Dateiname
  exportCSV(csv, zeitstempelDateiname("huemix_tag"));
}

function tagesSumme(){
  const l = JSON.parse(localStorage.getItem("huemix") || "[]");
  let bar = { r:0, b:0, s:0 };
  let ec  = { r:0, b:0, s:0 };

  l.forEach(e=>{
    if(!e) return;
    const r = Number(e.rasen) || 0;
    const b = Number(e.bio) || 0;
    const s = r*PREIS_RASEN + b*PREIS_BIO; // immer neu berechnen

    if (e.zahlung === "Bar") { bar.r+=r; bar.b+=b; bar.s+=s; }
    if (e.zahlung === "EC")  { ec.r+=r;  ec.b+=b;  ec.s+=s; }
  });

  let csv = "Zahlung;Rasen SÃ¤cke;Bio SÃ¤cke;Summe â‚¬\n";
  csv += `Bar;${bar.r};${bar.b};${bar.s}\n`;
  csv += `EC;${ec.r};${ec.b};${ec.s}\n`;

  status.textContent = `BAR: ${bar.s} â‚¬ | EC: ${ec.s} â‚¬`;
  exportCSV(csv, zeitstempelDateiname("huemix_tageszusammenfassung"));
}

function allesLoeschen(){
  if(confirm("Wirklich alle Daten lÃ¶schen?")){
    localStorage.removeItem("huemix");
    status.textContent = "Alle Daten gelÃ¶scht";
  }
}
</script>

</body>
</html>