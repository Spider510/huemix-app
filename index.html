<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>HÃœMIX Einsatz</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f4;
  padding: 15px;
}
h1 { color: #2e7d32; }
label { display: block; margin-top: 10px; }
input, select, button {
  width: 100%;
  padding: 10px;
  margin-top: 4px;
  font-size: 16px;
}
button {
  border: none;
  color: white;
  font-weight: bold;
  margin-top: 10px;
}
.btn-save { background: #2e7d32; }
.btn-new { background: #1976d2; }
.btn-csv { background: #455a64; }
.btn-del { background: #c62828; }
pre {
  background: #fff;
  padding: 10px;
  margin-top: 10px;
  white-space: pre-wrap;
}
</style>
</head>

<body>

<h1>ğŸŒ± HÃœMIX Einsatz</h1>

<label>Name<input id="name"></label>
<label>Telefon<input id="telefon"></label>
<label>StraÃŸe<input id="strasse"></label>
<label>Hausnummer<input id="hausnr"></label>
<label>PLZ<input id="plz"></label>
<label>Ort<input id="ort"></label>

<label>HÃœMIX Rasen Spezial â€“ SÃ¤cke (45 â‚¬)
<input id="rasen" type="number" value="0"></label>

<label>HÃœMIX Bio-VolldÃ¼nger â€“ SÃ¤cke (30 â‚¬)
<input id="bio" type="number" value="0"></label>

<label>Ausgestreut
<select id="ausgestreut">
  <option>Ja</option>
  <option>Nein</option>
</select>
</label>

<label>Zahlungsart
<select id="zahlung">
  <option>Bar</option>
  <option>EC</option>
  <option>Rechnung</option>
</select>
</label>

<button class="btn-save" onclick="speichern()">ğŸ’¾ Speichern</button>
<button class="btn-new" onclick="neu()">â• Neuer Eintrag</button>
<button class="btn-csv" onclick="exportCSV()">ğŸ“„ Tages-CSV exportieren</button>
<button class="btn-del" onclick="allesLoeschen()">ğŸ—‘ï¸ Alle Daten lÃ¶schen</button>

<pre id="status">GPS wird ermitteltâ€¦</pre>
<pre id="ausgabe"></pre>

<script>
const status = document.getElementById("status");
let lat = "";
let lon = "";

/* ================= GPS ================= */
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(gpsOK, gpsFail, {
    enableHighAccuracy: true,
    timeout: 8000,
    maximumAge: 60000
  });
} else {
  status.textContent = "GPS nicht unterstÃ¼tzt";
}

async function gpsOK(pos) {
  lat = pos.coords.latitude;
  lon = pos.coords.longitude;

  try {
    const res = await fetch(
      `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=de`,
      { headers: { "User-Agent": "huemix-app" } }
    );
    const data = await res.json();
    const a = data.address || {};

    if (a.road) strasse.value = a.road;
    if (a.house_number) hausnr.value = a.house_number;
    if (a.postcode) plz.value = a.postcode;
    if (a.city || a.town || a.village)
      ort.value = a.city || a.town || a.village;

    status.textContent = "GPS OK â€“ Adresse Ã¼bernommen";
  } catch {
    status.textContent = "GPS OK â€“ Adresse bitte ergÃ¤nzen";
  }
}

function gpsFail() {
  status.textContent = "GPS nicht verfÃ¼gbar â€“ manuelle Eingabe";
}

/* ================= SPEICHERN ================= */
function speichern() {
  const jetzt = new Date().toLocaleString("de-DE");
  const rasenPreis = rasen.value * 45;
  const bioPreis = bio.value * 30;
  const gesamt = rasenPreis + bioPreis;

  const zeile = [
    jetzt,
    name.value,
    telefon.value,
    strasse.value,
    hausnr.value,
    plz.value,
    ort.value,
    rasen.value,
    bio.value,
    ausgestreut.value,
    zahlung.value,
    gesamt
  ];

  let daten = JSON.parse(localStorage.getItem("huemix")) || [];
  daten.push(zeile);
  localStorage.setItem("huemix", JSON.stringify(daten));

  ausgabe.textContent =
    `Gespeichert:\n${jetzt}\n${strasse.value} ${hausnr.value}, ${plz.value} ${ort.value}\nGesamt: ${gesamt} â‚¬`;
}

/* ================= NEU ================= */
function neu() {
  document.querySelectorAll("input").forEach(i => {
    if (i.type === "number") i.value = 0;
    else i.value = "";
  });
}

/* ================= CSV ================= */
function exportCSV() {
  const daten = JSON.parse(localStorage.getItem("huemix")) || [];
  if (!daten.length) return alert("Keine Daten");

  const kopf = [
    "Datum","Name","Telefon","StraÃŸe","Hausnr","PLZ","Ort",
    "Rasen","Bio","Ausgestreut","Zahlung","Gesamt â‚¬"
  ];

  let csv = "\uFEFF" + kopf.join(";") + "\n";
  daten.forEach(z => csv += z.join(";") + "\n");

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "huemix_" + new Date().toISOString().slice(0,10) + ".csv";
  a.click();
}

/* ================= LÃ–SCHEN ================= */
function allesLoeschen() {
  if (confirm("Wirklich alle Daten lÃ¶schen?")) {
    localStorage.removeItem("huemix");
    ausgabe.textContent = "";
  }
}
</script>

</body>
</html>