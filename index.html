<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>HÃœMIX Einsatz</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial,sans-serif;background:#f4f7f4;margin:0;padding:12px}
h1{color:#2e7d32}
label{font-weight:bold;margin-top:10px;display:block}
input,select,button{width:100%;padding:10px;margin-top:4px;font-size:16px}
button{border:none;border-radius:4px;color:#fff;margin-top:8px}
.green{background:#2e7d32}
.blue{background:#1976d2}
.gray{background:#546e7a}
.purple{background:#7b1fa2}
.red{background:#c62828}
#status{margin-top:10px;font-size:14px}
</style>
</head>

<body>
<h1>ğŸŒ± HÃœMIX Einsatz</h1>

<label>Name</label><input id="name">
<label>Telefon</label><input id="telefon">
<label>StraÃŸe</label><input id="strasse">
<label>Hausnummer</label><input id="hausnr">
<label>PLZ</label><input id="plz">
<label>Ort</label><input id="ort">

<label>Rasen Spezial â€“ SÃ¤cke (45 â‚¬)</label><input id="rasen" type="number" value="0">
<label>Bio-VolldÃ¼nger â€“ SÃ¤cke (30 â‚¬)</label><input id="bio" type="number" value="0">

<label>Ausgestreut</label>
<select id="ausgestreut"><option>Ja</option><option>Nein</option></select>

<label>Zahlungsart</label>
<select id="zahlung"><option>Bar</option><option>EC</option></select>

<button class="blue" onclick="gpsHolen()">ğŸ“ GPS & Adresse holen</button>
<div id="gps">GPS noch nicht ermittelt</div>

<button class="green" onclick="speichern()">ğŸ’¾ Speichern</button>
<button class="blue" onclick="neu()">â• Neuer Eintrag</button>
<button class="gray" onclick="tagesCSV()">ğŸ“„ Tages-CSV</button>
<button class="purple" onclick="tagesSumme()">ğŸ“Š Tageszusammenfassung</button>
<button class="red" onclick="allesLoeschen()">ğŸ—‘ Alle Daten lÃ¶schen</button>

<div id="status">Bereit.</div>

<script>
let lat=null, lon=null;

function gpsHolen(){
  if(!navigator.geolocation){
    gps.textContent="GPS nicht verfÃ¼gbar";
    return;
  }

  gps.textContent="GPS wird ermitteltâ€¦";

  navigator.geolocation.getCurrentPosition(async p=>{
    lat=p.coords.latitude;
    lon=p.coords.longitude;
    gps.textContent=`GPS OK: ${lat.toFixed(6)}, ${lon.toFixed(6)}`;

    // Reverse Geocoding (OpenStreetMap)
    const url=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`;
    const r=await fetch(url,{headers:{'User-Agent':'HuemixApp'}});
    const d=await r.json();

    if(d.address){
      strasse.value=d.address.road||"";
      hausnr.value=d.address.house_number||"";
      plz.value=d.address.postcode||"";
      ort.value=d.address.city||d.address.town||d.address.village||"";
    }
  },()=>{
    gps.textContent="GPS Fehler";
  },{enableHighAccuracy:true,timeout:10000});
}

function zeit(){
  const d=new Date();
  return d.toLocaleDateString("de-DE")+" "+d.toLocaleTimeString("de-DE",{hour:'2-digit',minute:'2-digit'});
}

function speichern(){
  const r=Number(rasen.value)||0;
  const b=Number(bio.value)||0;
  const summe=r*45+b*30;

  const eintrag={
    datum:zeit(),
    name:name.value||"",
    telefon:telefon.value||"",
    strasse:strasse.value||"",
    hausnr:hausnr.value||"",
    plz:plz.value||"",
    ort:ort.value||"",
    rasen:r,
    bio:b,
    ausgestreut:ausgestreut.value,
    zahlung:zahlung.value,
    summe:summe
  };

  const l=JSON.parse(localStorage.getItem("huemix")||"[]");
  l.push(eintrag);
  localStorage.setItem("huemix",JSON.stringify(l));

  status.textContent="Gespeichert âœ”";
}

function neu(){
  document.querySelectorAll("input").forEach(i=>i.value="");
  rasen.value=0; bio.value=0;
  gps.textContent="GPS noch nicht ermittelt";
}

function tagesCSV(){
  const l=JSON.parse(localStorage.getItem("huemix")||"[]");
  let csv="\uFEFFDatum;Name;Telefon;StraÃŸe;Hausnr;PLZ;Ort;Rasen;Bio;Ausgestreut;Zahlung;Summe\n";
  l.forEach(e=>{
    csv+=`${e.datum};${e.name};${e.telefon};${e.strasse};${e.hausnr};${e.plz};${e.ort};${e.rasen};${e.bio};${e.ausgestreut};${e.zahlung};${e.summe}\n`;
  });
  download(csv,"huemix_tag.csv");
}

function tagesSumme(){
  const l=JSON.parse(localStorage.getItem("huemix")||"[]");
  let bar={r:0,b:0,s:0}, ec={r:0,b:0,s:0};

  l.forEach(e=>{
    if(e.zahlung==="Bar"){bar.r+=e.rasen;bar.b+=e.bio;bar.s+=e.summe;}
    if(e.zahlung==="EC"){ec.r+=e.rasen;ec.b+=e.bio;ec.s+=e.summe;}
  });

  let csv="\uFEFFZahlung;Rasen SÃ¤cke;Bio SÃ¤cke;Summe â‚¬\n";
  csv+=`Bar;${bar.r};${bar.b};${bar.s}\n`;
  csv+=`EC;${ec.r};${ec.b};${ec.s}\n`;
  download(csv,"huemix_tageszusammenfassung.csv");

  status.textContent=
`BAR: ${bar.r} Rasen / ${bar.b} Bio = ${bar.s} â‚¬
EC:  ${ec.r} Rasen / ${ec.b} Bio = ${ec.s} â‚¬`;
}

function allesLoeschen(){
  if(confirm("Wirklich alle Daten lÃ¶schen?")){
    localStorage.removeItem("huemix");
    status.textContent="Alle Daten gelÃ¶scht";
  }
}

function download(text,name){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([text],{type:"text/csv;charset=utf-8;"}));
  a.download=name;
  a.click();
}
</script>
</body>
</html>