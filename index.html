<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>HÃœMIX Einsatz</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; background:#f4f6f4; padding:15px; }
h1 { color:#2e7d32; }
label { display:block; margin-top:10px; font-weight:bold; }
input, select, button {
  width:100%; padding:8px; margin-top:4px;
  border-radius:4px; border:1px solid #ccc;
}
button { background:#2e7d32; color:white; font-size:16px; margin-top:15px; }
pre { background:#fff; padding:10px; margin-top:15px; white-space:pre-wrap; }
</style>
</head>

<body>

<h1>ðŸŒ± HÃœMIX Einsatz</h1>

<label>Name<input id="name"></label>
<label>Telefon<input id="telefon"></label>
<label>StraÃŸe<input id="strasse"></label>
<label>Hausnummer<input id="hausnummer"></label>
<label>PLZ<input id="plz"></label>
<label>Ort<input id="ort"></label>

<label>HÃœMIX Rasen Spezial â€“ SÃ¤cke<input id="rasen" type="number" value="0"></label>
<label>HÃœMIX Bio-VolldÃ¼nger â€“ SÃ¤cke<input id="bio" type="number" value="0"></label>

<label>Ausgestreut
<select id="ausgestreut">
  <option>Ja</option>
  <option>Nein</option>
</select>
</label>

<button onclick="speichern()">Speichern</button>
<button onclick="exportCSV()">ðŸ“¥ Tages-CSV exportieren</button>

<pre id="ausgabe">GPS wird ermitteltâ€¦</pre>

<script>
const f = id => document.getElementById(id);
let lat="", lon="";

/* GPS nur fÃ¼r Adresse */
navigator.geolocation.getCurrentPosition(
  pos => {
    lat = pos.coords.latitude;
    lon = pos.coords.longitude;
    reverseGeocode();
    f("ausgabe").textContent = "Adresse automatisch ermittelt";
  },
  err => f("ausgabe").textContent = "GPS-Fehler: " + err.message,
  { enableHighAccuracy:true, timeout:10000 }
);

/* Adresse + PLZ holen */
function reverseGeocode(){
  fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`)
  .then(r=>r.json())
  .then(d=>{
    const a = d.address || {};
    if(!f("strasse").value) f("strasse").value = a.road || "";
    if(!f("hausnummer").value) f("hausnummer").value = a.house_number || "";
    if(!f("plz").value) f("plz").value = a.postcode || "";
    if(!f("ort").value) f("ort").value = a.city || a.town || a.village || "";
  });
}

function speichern(){
  const jetzt = new Date().toLocaleString("de-DE");

  const eintrag = [
    jetzt,
    f("name").value,
    f("telefon").value,
    f("strasse").value,
    f("hausnummer").value,
    f("plz").value,
    f("ort").value,
    f("rasen").value,
    f("bio").value,
    f("ausgestreut").value
  ].join(";");

  const liste = JSON.parse(localStorage.getItem("huemix")) || [];
  liste.push(eintrag);
  localStorage.setItem("huemix", JSON.stringify(liste));

  f("ausgabe").textContent =
`Gespeichert:
${jetzt}
${f("strasse").value} ${f("hausnummer").value}
${f("plz").value} ${f("ort").value}`;
}

/* Excel-saubere CSV */
function exportCSV(){
  const daten = JSON.parse(localStorage.getItem("huemix")) || [];
  if(!daten.length){ alert("Keine Daten vorhanden"); return; }

  const header =
"Datum;Name;Telefon;StraÃŸe;Hausnr;PLZ;Ort;Rasen;Bio;Ausgestreut\n";

  const bom = "\uFEFF"; // Excel-Umlaute
  const blob = new Blob([bom + header + daten.join("\n")],
    {type:"text/csv;charset=utf-8;"});

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "huemix_" + new Date().toISOString().slice(0,10) + ".csv";
  a.click();
}
</script>

</body>
</html>