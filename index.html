<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>HÃœMIX Einsatz</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; background:#f5f7f5; margin:0; }
.container { max-width:900px; margin:auto; padding:15px; }
h1 { color:#2e7d32; }
label { font-weight:bold; display:block; margin-top:12px; }
input, select, button {
  width:100%; padding:10px; margin-top:4px;
  border-radius:6px; border:1px solid #ccc;
}
button { font-size:16px; cursor:pointer; }
.green { background:#2e7d32; color:#fff; }
.blue { background:#1976d2; color:#fff; }
.gray { background:#455a64; color:#fff; }
.purple { background:#6a1b9a; color:#fff; }
.red { background:#c62828; color:#fff; }
.small { font-size:14px; margin-top:6px; }
</style>
</head>

<body>
<div class="container">
<h1>ğŸŒ± HÃœMIX Einsatz</h1>

<label>Name</label>
<input id="name">

<label>Telefon</label>
<input id="telefon">

<label>StraÃŸe</label>
<input id="strasse">

<label>Hausnummer</label>
<input id="hausnr">

<label>PLZ</label>
<input id="plz">

<label>Ort</label>
<input id="ort">

<label>Rasen Spezial â€“ SÃ¤cke (45 â‚¬)</label>
<input id="rasen" type="number" value="0">

<label>Bio-VolldÃ¼nger â€“ SÃ¤cke (30 â‚¬)</label>
<input id="bio" type="number" value="0">

<label>Ausgestreut</label>
<select id="ausgestreut">
  <option>Ja</option>
  <option>Nein</option>
</select>

<label>Zahlungsart</label>
<select id="zahlung">
  <option>Bar</option>
  <option>EC</option>
</select>

<button class="blue" onclick="gpsHolen()">ğŸ“ GPS neu holen</button>
<div id="gpsStatus" class="small">GPS noch nicht ermittelt</div>

<button class="green" onclick="speichern()">ğŸ’¾ Speichern</button>
<button class="blue" onclick="neuerEintrag()">â• Neuer Eintrag</button>
<button class="gray" onclick="tagesCSV()">ğŸ“„ Tages-CSV</button>
<button class="purple" onclick="tagesZusammenfassung()">ğŸ“Š Tageszusammenfassung</button>
<button class="red" onclick="allesLoeschen()">ğŸ—‘ï¸ Alle Daten lÃ¶schen</button>

<div id="status" class="small">Bereit.</div>
</div>

<script>
const PREIS_RASEN = 45;
const PREIS_BIO = 30;
let gps = null;

function heuteDatum() {
  const d = new Date();
  return d.toLocaleDateString("de-DE");
}

function datumMitUhrzeit() {
  const d = new Date();
  return d.toLocaleDateString("de-DE") + " " +
         d.toLocaleTimeString("de-DE", {hour:'2-digit', minute:'2-digit'});
}

function gpsHolen() {
  gps = null;
  neuerEintrag();
  if (!navigator.geolocation) {
    gpsStatus.innerText = "GPS nicht unterstÃ¼tzt";
    return;
  }
  navigator.geolocation.getCurrentPosition(pos => {
    gps = pos.coords;
    gpsStatus.innerText = `GPS OK: ${gps.latitude.toFixed(5)}, ${gps.longitude.toFixed(5)}`;
    reverseGeocode(gps.latitude, gps.longitude);
  }, () => gpsStatus.innerText = "GPS Fehler");
}

function reverseGeocode(lat, lon) {
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
    .then(r => r.json())
    .then(d => {
      if (!d.address) return;
      strasse.value = d.address.road || "";
      hausnr.value = d.address.house_number || "";
      plz.value = d.address.postcode || "";
      ort.value = d.address.city || d.address.town || d.address.village || "";
    });
}

function speichern() {
  const eintrag = {
    datum: datumMitUhrzeit(),
    name: name.value.trim(),
    telefon: telefon.value.trim(),
    strasse: strasse.value.trim(),
    hausnr: hausnr.value.trim(),
    plz: plz.value.trim(),
    ort: ort.value.trim(),
    rasen: Number(rasen.value),
    bio: Number(bio.value),
    ausgestreut: ausgestreut.value,
    zahlung: zahlung.value
  };
  eintrag.summe = eintrag.rasen * PREIS_RASEN + eintrag.bio * PREIS_BIO;

  const liste = JSON.parse(localStorage.getItem("huemix") || "[]");
  liste.push(eintrag);
  localStorage.setItem("huemix", JSON.stringify(liste));

  neuerEintrag();
  status.innerText = "Gespeichert âœ”";
}

function neuerEintrag() {
  document.querySelectorAll("input").forEach(i => i.value = "");
  rasen.value = 0;
  bio.value = 0;
  ausgestreut.value = "Ja";
  zahlung.value = "Bar";
  gpsStatus.innerText = "GPS noch nicht ermittelt";
}

function allesLoeschen() {
  if (confirm("Wirklich ALLE Daten lÃ¶schen?")) {
    localStorage.removeItem("huemix");
    status.innerText = "Alle Daten gelÃ¶scht";
  }
}

function csvDownload(name, text) {
  const blob = new Blob(["\ufeff" + text], { type: "text/csv;charset=utf-8;" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
}

function tagesCSV() {
  const liste = JSON.parse(localStorage.getItem("huemix") || "[]");
  let csv = "Datum;Name;Telefon;StraÃŸe;Hausnr;PLZ;Ort;Rasen;Bio;Ausgestreut;Zahlung;Summe\n";
  liste.forEach(e => {
    csv += [
      e.datum, e.name, e.telefon, e.strasse, e.hausnr, e.plz,
      e.ort, e.rasen, e.bio, e.ausgestreut, e.zahlung, e.summe
    ].join(";") + "\n";
  });
  csvDownload("huemix_tagesliste.csv", csv);
}

function tagesZusammenfassung() {
  const liste = JSON.parse(localStorage.getItem("huemix") || "[]");
  let bar = { r:0, b:0, s:0 };
  let ec  = { r:0, b:0, s:0 };

  liste.forEach(e => {
    const t = e.zahlung === "Bar" ? bar : ec;
    t.r += e.rasen;
    t.b += e.bio;
    t.s += e.summe;
  });

  const ges = {
    r: bar.r + ec.r,
    b: bar.b + ec.b,
    s: bar.s + ec.s
  };

  let csv =
`Datum:${heuteDatum()}
Zahlung;Rasen SÃ¤cke;Bio SÃ¤cke;Summe â‚¬
Bar;${bar.r};${bar.b};${bar.s}
EC;${ec.r};${ec.b};${ec.s}
GESAMT;${ges.r};${ges.b};${ges.s}`;

  csvDownload("huemix_tageszusammenfassung.csv", csv);
}
</script>
</body>
</html>