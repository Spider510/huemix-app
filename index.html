<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>HÃœMIX Einsatz</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; background:#f3f7f2; padding:20px; }
h1 { color:#2e7d32; }
label { font-weight:bold; display:block; margin-top:12px; }
input, select, button, textarea {
  width:100%; padding:10px; margin-top:4px; font-size:16px;
}
button { color:white; border:none; margin-top:10px; }
.save { background:#2e7d32; }
.new { background:#1976d2; }
.csv { background:#455a64; }
.del { background:#c62828; }
pre { background:white; padding:10px; white-space:pre-wrap; }
</style>
</head>

<body>

<h1>ðŸŒ± HÃœMIX Einsatz</h1>

<label>Name<input id="name"></label>
<label>Telefon<input id="telefon"></label>
<label>StraÃŸe<input id="strasse"></label>
<label>Hausnummer<input id="hausnr"></label>
<label>PLZ<input id="plz"></label>
<label>Ort<input id="ort"></label>

<label>HÃœMIX Rasen Spezial â€“ SÃ¤cke (45 â‚¬)
<input id="rasen" type="number" value="0"></label>

<label>HÃœMIX Bio-VolldÃ¼nger â€“ SÃ¤cke (30 â‚¬)
<input id="bio" type="number" value="0"></label>

<label>Ausgestreut
<select id="ausgestreut">
  <option>Ja</option>
  <option>Nein</option>
</select></label>

<label>Zahlungsart
<select id="zahlung">
  <option>Bar</option>
  <option>EC</option>
  <option>Rechnung</option>
</select></label>

<button class="save" onclick="speichern()">ðŸ’¾ Speichern</button>
<button class="new" onclick="neu()">âž• Neuer Eintrag</button>
<button class="csv" onclick="exportCSV()">ðŸ“„ Tages-CSV</button>
<button class="csv" onclick="exportSummaryCSV()">ðŸ“Š Tages-Zusammenfassung CSV</button>
<button class="del" onclick="allesLoeschen()">ðŸ—‘ Alle Daten lÃ¶schen</button>

<pre id="status">GPS wird ermitteltâ€¦</pre>

<script>
const PREIS_RASEN = 45;
const PREIS_BIO = 30;

/* ========= GPS + ADRESSE ========= */
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(
    gpsOK,
    gpsFail,
    { enableHighAccuracy:true, timeout:8000, maximumAge:60000 }
  );
} else {
  status.textContent = "GPS nicht unterstÃ¼tzt";
}

async function gpsOK(pos) {
  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;

  status.textContent = "GPS OK â€“ Adresse wird geladenâ€¦";

  try {
    const res = await fetch(
      `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=de`,
      { headers: { "User-Agent": "huemix-app" } }
    );

    if (!res.ok) throw new Error("Adresse nicht erreichbar");

    const data = await res.json();
    const a = data.address || {};

    if (!strasse.value && a.road) strasse.value = a.road;
    if (!hausnr.value && a.house_number) hausnr.value = a.house_number;
    if (!plz.value && a.postcode) plz.value = a.postcode;
    if (!ort.value) ort.value = a.city || a.town || a.village || "";

    status.textContent = "Adresse automatisch Ã¼bernommen";
  } catch {
    status.textContent = "GPS OK â€“ Adresse bitte manuell ergÃ¤nzen";
  }
}

function gpsFail() {
  status.textContent = "GPS nicht verfÃ¼gbar â€“ manuelle Eingabe";
}

/* ========= SPEICHERN ========= */
function heuteKey() {
  return new Date().toISOString().slice(0,10);
}

function speichern() {
  const rasen = Number(rasen.value || 0);
  const bio = Number(bio.value || 0);
  const gesamt = rasen*PREIS_RASEN + bio*PREIS_BIO;

  const daten = JSON.parse(localStorage.getItem("huemix")) || [];
  daten.push({
    isoDate: heuteKey(),
    datum: new Date().toLocaleString("de-DE"),
    name: name.value,
    telefon: telefon.value,
    strasse: strasse.value,
    hausnr: hausnr.value,
    plz: plz.value,
    ort: ort.value,
    rasen, bio,
    ausgestreut: ausgestreut.value,
    zahlung: zahlung.value,
    gesamt
  });

  localStorage.setItem("huemix", JSON.stringify(daten));
  status.textContent = `Gespeichert â€“ Gesamt ${gesamt} â‚¬`;
}

function neu() {
  document.querySelectorAll("input").forEach(i=>{
    if (i.type==="number") i.value=0; else i.value="";
  });
}

/* ========= CSV EINZEL ========= */
function exportCSV() {
  const daten = JSON.parse(localStorage.getItem("huemix")) || [];
  const heute = daten.filter(e=>e.isoDate===heuteKey());
  if (!heute.length) return alert("Keine Daten");

  let csv="\uFEFFDatum;Name;Telefon;StraÃŸe;Hausnr;PLZ;Ort;Rasen;Bio;Ausgestreut;Zahlung;Summe\n";
  heute.forEach(e=>{
    csv+=`${e.datum};${e.name};${e.telefon};${e.strasse};${e.hausnr};${e.plz};${e.ort};${e.rasen};${e.bio};${e.ausgestreut};${e.zahlung};${e.gesamt}\n`;
  });
  download(csv, "huemix_"+heuteKey()+".csv");
}

/* ========= CSV ZUSAMMENFASSUNG ========= */
function exportSummaryCSV() {
  const daten = JSON.parse(localStorage.getItem("huemix")) || [];
  const heute = daten.filter(e=>e.isoDate===heuteKey());

  const sum = {Bar:[0,0,0],EC:[0,0,0],Rechnung:[0,0,0]};
  heute.forEach(e=>{
    sum[e.zahlung][0]+=e.rasen;
    sum[e.zahlung][1]+=e.bio;
    sum[e.zahlung][2]+=e.gesamt;
  });

  let csv="\uFEFFZahlung;Rasen_SÃ¤cke;Bio_SÃ¤cke;Summe_EUR\n";
  Object.keys(sum).forEach(z=>{
    csv+=`${z};${sum[z][0]};${sum[z][1]};${sum[z][2]}\n`;
  });
  download(csv, "huemix_zusammenfassung_"+heuteKey()+".csv");
}

function download(text,name){
  const blob=new Blob([text],{type:"text/csv;charset=utf-8;"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=name;
  a.click();
}

/* ========= LÃ–SCHEN ========= */
function allesLoeschen() {
  if (confirm("Wirklich ALLE Daten lÃ¶schen?")) {
    localStorage.removeItem("huemix");
    status.textContent="Alle Daten gelÃ¶scht";
  }
}
</script>

</body>
</html>