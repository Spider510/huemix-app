<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>HÃœMIX Einsatz</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; background:#f4f6f4; padding:15px; }
h1 { color:#2e7d32; }
label { display:block; margin-top:10px; }
input, select, button, textarea {
  width:100%; padding:10px; margin-top:4px; font-size:16px;
}
button { border:none; color:white; font-weight:bold; margin-top:10px; }
.btn-save { background:#2e7d32; }
.btn-new  { background:#1976d2; }
.btn-csv  { background:#455a64; }
.btn-sum  { background:#6a1b9a; }
.btn-del  { background:#c62828; }
pre, textarea {
  background:#fff; padding:10px; margin-top:10px; white-space:pre-wrap;
  border:1px solid #ddd; border-radius:6px;
}
.small { font-size:13px; color:#444; }
</style>
</head>

<body>

<h1>ğŸŒ± HÃœMIX Einsatz</h1>

<label>Name<input id="name"></label>
<label>Telefon<input id="telefon"></label>
<label>StraÃŸe<input id="strasse"></label>
<label>Hausnummer<input id="hausnr"></label>
<label>PLZ<input id="plz"></label>
<label>Ort<input id="ort"></label>

<label>HÃœMIX Rasen Spezial â€“ SÃ¤cke (45 â‚¬)
<input id="rasen" type="number" value="0" min="0"></label>

<label>HÃœMIX Bio-VolldÃ¼nger â€“ SÃ¤cke (30 â‚¬)
<input id="bio" type="number" value="0" min="0"></label>

<label>Ausgestreut
<select id="ausgestreut">
  <option>Ja</option>
  <option>Nein</option>
</select>
</label>

<label>Zahlungsart
<select id="zahlung">
  <option>Bar</option>
  <option>EC</option>
  <option>Rechnung</option>
</select>
</label>

<button class="btn-save" onclick="speichern()">ğŸ’¾ Speichern</button>
<button class="btn-new" onclick="neu()">â• Neuer Eintrag</button>
<button class="btn-sum" onclick="tagesZusammenfassung()">ğŸ§¾ Tages-Zusammenfassung</button>
<button class="btn-csv" onclick="exportCSV()">ğŸ“„ Tages-CSV exportieren</button>
<button class="btn-del" onclick="allesLoeschen()">ğŸ—‘ï¸ Alle Daten lÃ¶schen</button>

<pre id="status">GPS wird ermitteltâ€¦</pre>
<pre id="ausgabe"></pre>

<div class="small">Falls iOS den Download blockt: CSV steht unten im Feld und kann kopiert/geteilt werden.</div>
<textarea id="csvbox" rows="8" placeholder="Hier erscheint die CSV zum Kopierenâ€¦"></textarea>

<script>
/* ====== Elemente ====== */
const status  = document.getElementById("status");
const ausgabe = document.getElementById("ausgabe");
const csvbox  = document.getElementById("csvbox");

const nameEl     = document.getElementById("name");
const telEl      = document.getElementById("telefon");
const strEl      = document.getElementById("strasse");
const hausEl     = document.getElementById("hausnr");
const plzEl      = document.getElementById("plz");
const ortEl      = document.getElementById("ort");
const rasenEl    = document.getElementById("rasen");
const bioEl      = document.getElementById("bio");
const ausgEl     = document.getElementById("ausgestreut");
const zahlEl     = document.getElementById("zahlung");

/* ====== Preise ====== */
const PREIS_RASEN = 45;
const PREIS_BIO   = 30;

/* ====== GPS & Adresse ====== */
let lat = "";
let lon = "";

if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(gpsOK, gpsFail, {
    enableHighAccuracy: true,
    timeout: 8000,
    maximumAge: 60000
  });
} else {
  status.textContent = "GPS nicht unterstÃ¼tzt";
}

async function gpsOK(pos) {
  lat = pos.coords.latitude;
  lon = pos.coords.longitude;

  try {
    const res = await fetch(
      `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=de`,
      { headers: { "User-Agent": "huemix-app" } }
    );
    const data = await res.json();
    const a = data.address || {};

    if (a.road)        strEl.value  = a.road;
    if (a.house_number)hausEl.value = a.house_number;
    if (a.postcode)    plzEl.value  = a.postcode;

    const city = a.city || a.town || a.village || a.hamlet || "";
    if (city) ortEl.value = city;

    status.textContent = "GPS OK â€“ Adresse Ã¼bernommen (ggf. ergÃ¤nzen)";
  } catch {
    status.textContent = "GPS OK â€“ Adresse bitte manuell ergÃ¤nzen";
  }
}

function gpsFail(err) {
  status.textContent = "GPS nicht verfÃ¼gbar â€“ manuelle Eingabe";
}

/* ====== Helfer: Heute ====== */
function heuteKey() {
  // Lokales Datum YYYY-MM-DD
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const t = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${t}`;
}

/* ====== Datenformat ======
   Wir speichern ein Objekt pro Eintrag:
   {
     isoDate: "2026-02-06",
     datetime: "06.02.2026, 13:58:08",
     name, telefon, strasse, hausnr, plz, ort,
     rasen, bio, ausgestreut, zahlung,
     gesamt
   }
================================= */

function speichern() {
  const dt = new Date();
  const iso = heuteKey();
  const datetime = dt.toLocaleString("de-DE");

  const rasen = Number(rasenEl.value || 0);
  const bio   = Number(bioEl.value || 0);

  const gesamt = rasen * PREIS_RASEN + bio * PREIS_BIO;

  const eintrag = {
    isoDate: iso,
    datetime,
    name: nameEl.value.trim(),
    telefon: telEl.value.trim(),
    strasse: strEl.value.trim(),
    hausnr: hausEl.value.trim(),
    plz: plzEl.value.trim(),
    ort: ortEl.value.trim(),
    rasen,
    bio,
    ausgestreut: ausgEl.value,
    zahlung: zahlEl.value,
    gesamt
  };

  let daten = JSON.parse(localStorage.getItem("huemix")) || [];
  daten.push(eintrag);
  localStorage.setItem("huemix", JSON.stringify(daten));

  ausgabe.textContent =
`Gespeichert:
${datetime}
Adresse: ${eintrag.strasse} ${eintrag.hausnr}, ${eintrag.plz} ${eintrag.ort}
Rasen: ${rasen} | Bio: ${bio}
Zahlung: ${eintrag.zahlung}
Gesamt: ${gesamt} â‚¬`;

  csvbox.value = ""; // optional leeren
}

function neu() {
  // Felder leeren â€“ Mengen auf 0
  nameEl.value = "";
  telEl.value = "";
  // Adresse bewusst NICHT komplett lÃ¶schen? -> doch, nach Wunsch:
  strEl.value = "";
  hausEl.value = "";
  plzEl.value = "";
  ortEl.value = "";

  rasenEl.value = 0;
  bioEl.value = 0;
  ausgEl.value = "Ja";
  zahlEl.value = "Bar";

  ausgabe.textContent = "";
}

/* ====== Tages-Zusammenfassung ====== */
function tagesZusammenfassung() {
  const daten = JSON.parse(localStorage.getItem("huemix")) || [];
  const tag = heuteKey();
  const heute = daten.filter(e => e.isoDate === tag);

  if (!heute.length) {
    ausgabe.textContent = "Heute noch keine EintrÃ¤ge gespeichert.";
    return;
  }

  const gruppen = {
    "Bar":      { rasen:0, bio:0, sum:0 },
    "EC":       { rasen:0, bio:0, sum:0 },
    "Rechnung": { rasen:0, bio:0, sum:0 }
  };

  heute.forEach(e => {
    const g = gruppen[e.zahlung] || (gruppen[e.zahlung] = {rasen:0,bio:0,sum:0});
    g.rasen += Number(e.rasen || 0);
    g.bio   += Number(e.bio || 0);
    g.sum   += Number(e.gesamt || 0);
  });

  const totalRasen = heute.reduce((a,e)=>a+Number(e.rasen||0),0);
  const totalBio   = heute.reduce((a,e)=>a+Number(e.bio||0),0);
  const totalSum   = heute.reduce((a,e)=>a+Number(e.gesamt||0),0);

  ausgabe.textContent =
`ğŸ§¾ Tages-Zusammenfassung (${tag})
EintrÃ¤ge: ${heute.length}

BAR:
- Rasen SÃ¤cke: ${gruppen["Bar"].rasen}
- Bio SÃ¤cke:   ${gruppen["Bar"].bio}
- Summe â‚¬:     ${gruppen["Bar"].sum}

EC:
- Rasen SÃ¤cke: ${gruppen["EC"].rasen}
- Bio SÃ¤cke:   ${gruppen["EC"].bio}
- Summe â‚¬:     ${gruppen["EC"].sum}

RECHNUNG:
- Rasen SÃ¤cke: ${gruppen["Rechnung"].rasen}
- Bio SÃ¤cke:   ${gruppen["Rechnung"].bio}
- Summe â‚¬:     ${gruppen["Rechnung"].sum}

GESAMT:
- Rasen SÃ¤cke: ${totalRasen}
- Bio SÃ¤cke:   ${totalBio}
- Summe â‚¬:     ${totalSum}`;
}

/* ====== Tages-CSV Export ====== */
function exportCSV() {
  const daten = JSON.parse(localStorage.getItem("huemix")) || [];
  const tag = heuteKey();
  const heute = daten.filter(e => e.isoDate === tag);

  if (!heute.length) {
    alert("Heute keine Daten.");
    return;
  }

  const header = [
    "Datum/Uhrzeit","Name","Telefon","StraÃŸe","Hausnr","PLZ","Ort",
    "Rasen_SÃ¤cke","Bio_SÃ¤cke","Ausgestreut","Zahlung","Gesamt_EUR"
  ];

  // BOM fÃ¼r Excel + UTF-8
  let csv = "\uFEFF" + header.join(";") + "\n";

  heute.forEach(e => {
    const row = [
      e.datetime,
      e.name,
      e.telefon,
      e.strasse,
      e.hausnr,
      e.plz,
      e.ort,
      e.rasen,
      e.bio,
      e.ausgestreut,
      e.zahlung,
      e.gesamt
    ].map(v => String(v ?? "").replaceAll(";", ","));
    csv += row.join(";") + "\n";
  });

  // Immer auch anzeigen (falls Download blockt)
  csvbox.value = csv;

  // Download versuchen
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const filename = "huemix_" + tag + ".csv";

  // iOS Workaround: erst teilen, wenn verfÃ¼gbar
  if (navigator.canShare && navigator.canShare({ files: [new File([blob], filename, {type:"text/csv"})] })) {
    const file = new File([blob], filename, { type: "text/csv" });
    navigator.share({ files: [file], title: filename })
      .catch(() => {
        // falls Teilen abgebrochen -> fallback Download
        downloadBlob(blob, filename);
      });
  } else {
    downloadBlob(blob, filename);
  }
}

function downloadBlob(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 2000);
}

/* ====== Alles lÃ¶schen ====== */
function allesLoeschen() {
  if (confirm("Wirklich alle Daten lÃ¶schen?")) {
    localStorage.removeItem("huemix");
    ausgabe.textContent = "";
    csvbox.value = "";
  }
}
</script>

</body>
</html>